{% extends 'base.html' %}
{% load static %}

{% block title %}Book a Pickup - ScrapeWale{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card glass-card border-0 shadow-lg rounded-4 p-3">
                <div class="text-center mb-2">
                    <div class="bg-success bg-opacity-10 d-inline-block p-2 rounded-circle mb-2">
                        <i class="fas fa-truck-pickup fa-lg text-success"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-1">Schedule Pickup</h4>
                    <p class="text-muted small mb-0">Fill in the details below to schedule your scrap pickup.</p>
                </div>

                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger rounded-3 py-2 small">
                        {% for error in form.non_field_errors %}
                        {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="mb-2">
                        <label for="{{ form.scrap_category.id_for_label }}"
                            class="form-label fw-bold small text-muted text-uppercase mb-1">Select Scrap
                            Category</label>
                        {{ form.scrap_category }}
                        {% if form.scrap_category.errors %}
                        <div class="text-danger small mt-1">{{ form.scrap_category.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Address Field with Select on Map Button -->
                    <div class="mb-2">
                        <div class="d-flex align-items-center justify-content-between mb-1">
                            <label for="{{ form.address.id_for_label }}"
                                class="form-label fw-bold small text-muted text-uppercase mb-0">Address</label>
                            <button type="button" class="btn btn-outline-success btn-sm rounded-pill px-3 py-0"
                                data-bs-toggle="modal" data-bs-target="#mapModal" style="font-size: 0.75rem;">
                                <i class="fas fa-map-marker-alt me-1"></i> Select on Map
                            </button>
                        </div>
                        {{ form.address }}
                        {% if form.address.errors %}
                        <div class="text-danger small mt-1">{{ form.address.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text text-muted small mt-1" id="location-status" style="font-size: 0.75rem;">
                            <i class="fas fa-info-circle me-1"></i>Search/Select on map to auto-fill.
                        </div>
                    </div>

                    <!-- Location Details (Lat, Lng, Pincode) -->
                    <div class="mb-2">
                        <label class="form-label fw-bold small text-muted text-uppercase mb-1">Location Details</label>
                        <div class="d-flex align-items-stretch gap-2 loc-details-row">
                            <div class="input-group flex-nowrap input-group-sm">
                                <span class="input-group-text bg-white"><i class="fas fa-globe text-muted"></i></span>
                                {{ form.latitude }}
                            </div>
                            <span class="d-flex align-items-center text-muted fw-bold px-0">,</span>
                            <div class="input-group flex-nowrap input-group-sm">
                                {{ form.longitude }}
                            </div>
                            <div class="input-group flex-nowrap input-group-sm">
                                <span class="input-group-text bg-white"><i
                                        class="fas fa-building text-muted"></i></span>
                                {{ form.pincode }}
                            </div>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.estimated_weight.id_for_label }}"
                                class="form-label fw-bold small text-muted text-uppercase mb-1">Est. Weight (Kg)</label>
                            {{ form.estimated_weight }}
                            {% if form.estimated_weight.errors %}
                            <div class="text-danger small mt-1">{{ form.estimated_weight.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.scheduled_date.id_for_label }}"
                                class="form-label fw-bold small text-muted text-uppercase mb-1">Preferred Time</label>
                            {{ form.scheduled_date }}
                            {% if form.scheduled_date.errors %}
                            <div class="text-danger small mt-1">{{ form.scheduled_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning btn-lg rounded-pill fw-bold text-white shadow-sm"
                            style="background-color: #ff9800; border: none;">
                            Schedule Pickup
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold" id="mapModalLabel"><i class="fas fa-map-marked-alt me-2"></i> Pin Your
                    Location</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 position-relative">
                <div id="map" style="height: 400px; width: 100%;"></div>
            </div>
            <div class="modal-footer bg-light">
                <small class="text-muted me-auto"><i class="fas fa-info-circle me-1"></i> Search or drag marker to
                    adjust.</small>
                <button type="button" class="btn btn-success rounded-pill px-4" data-bs-dismiss="modal">Confirm
                    Location</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Tweaks for Form Controls to match theme */
    .form-control:focus,
    .form-select:focus {
        border-color: #2e7d32;
        box-shadow: 0 0 0 0.25rem rgba(46, 125, 50, 0.25);
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }

    body.dark-mode .glass-card {
        background: rgba(30, 30, 30, 0.95);
    }

    body.dark-mode .text-dark {
        color: #f8f9fa !important;
    }

    /* Location Details row alignment */
    .loc-details-row .input-group {
        flex: 1 1 0;
        min-width: 0;
    }

    .loc-details-row .input-group input,
    .loc-details-row .input-group select,
    .loc-details-row .input-group textarea {
        flex: 1 1 auto;
        width: 1%;
        min-width: 0;
        border-radius: 0 0.375rem 0.375rem 0 !important;
    }

    .loc-details-row .input-group .input-group-text {
        border-radius: 0.375rem 0 0 0.375rem !important;
    }

    /* For input groups without a prepend icon (longitude) */
    .loc-details-row .input-group:not(:has(.input-group-text)) input {
        border-radius: 0.375rem !important;
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mehsana Coordinates
        var defaultLat = 23.5880;
        var defaultLng = 72.3693;

        // Define Mehsana Bounds
        var southWest = L.latLng(23.5000, 72.3000);
        var northEast = L.latLng(23.7000, 72.5000);
        var bounds = L.latLngBounds(southWest, northEast);

        var map = null;
        var marker = null;

        // Function to init map only when modal opens (fixes grey map issue)
        function initMap() {
            if (map) return; // Already initialized

            map = L.map('map', {
                maxBounds: bounds,
                maxBoundsViscosity: 1.0,
                minZoom: 12
            }).setView([defaultLat, defaultLng], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

            marker.on('dragend', function (e) {
                var lat = e.target.getLatLng().lat;
                var lng = e.target.getLatLng().lng;
                fetchAddress(lat, lng); // Reverse Geocode on drag
                updateInputs(lat, lng);
            });

            map.on('click', function (e) {
                if (bounds.contains(e.latlng)) {
                    marker.setLatLng(e.latlng);
                    fetchAddress(e.latlng.lat, e.latlng.lng); // Reverse Geocode on click
                    updateInputs(e.latlng.lat, e.latlng.lng);
                }
            });

            // Add Geocoder Control
            L.Control.geocoder({
                defaultMarkGeocode: false,
                geocoder: L.Control.Geocoder.nominatim({
                    geocodingQueryParams: {
                        'viewbox': '72.3000,23.7000,72.5000,23.5000',
                        'bounded': 1
                    }
                })
            })
                .on('markgeocode', function (e) {
                    var latlng = e.geocode.center;
                    if (bounds.contains(latlng)) {
                        marker.setLatLng(latlng);
                        map.setView(latlng, 16);

                        // Extract Details from Geocoder Result
                        var address = e.geocode.name;
                        var props = e.geocode.properties;
                        var pincode = "";

                        // Try to find postcode in properties if available
                        if (props && props.address && props.address.postcode) {
                            pincode = props.address.postcode;
                        }

                        updateInputs(latlng.lat, latlng.lng, address, pincode);
                    } else {
                        alert("Please select a location within Mehsana.");
                    }
                })
                .addTo(map);

            // Geolocation
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var latlng = L.latLng(lat, lng);
                    if (bounds.contains(latlng)) {
                        map.setView(latlng, 16);
                        marker.setLatLng(latlng);
                        updateInputs(lat, lng);
                        fetchAddress(lat, lng);
                    }
                });
            }
        }

        // Reverse Geocoding Function
        function fetchAddress(lat, lng) {
            var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + lat + '&lon=' + lng;

            fetch(url, {
                headers: {
                    'User-Agent': 'ScrapeWale/1.0'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        var address = data.display_name;
                        var pincode = "";
                        if (data.address && data.address.postcode) {
                            pincode = data.address.postcode;
                        }
                        updateInputs(lat, lng, address, pincode);
                    }
                })
                .catch(error => console.error('Error fetching address:', error));
        }

        // Update inputs
        function updateInputs(lat, lng, address, pincode) {
            var latInput = document.getElementById('id_latitude');
            var lngInput = document.getElementById('id_longitude');
            var addrInput = document.getElementById('id_address');
            var pinInput = document.getElementById('id_pincode');
            var statusDiv = document.getElementById('location-status');

            if (latInput) latInput.value = lat.toFixed(6);
            if (lngInput) lngInput.value = lng.toFixed(6);

            if (address && addrInput) addrInput.value = address;
            if (pincode && pinInput) pinInput.value = pincode;

            if (statusDiv) {
                statusDiv.innerHTML = '<i class="fas fa-check-circle text-success"></i> Location selected (' + lat.toFixed(4) + ', ' + lng.toFixed(4) + ')';
                statusDiv.className = 'form-text text-success fw-bold';
            }
        }

        // Initialize inputs
        updateInputs(defaultLat, defaultLng);

        // Modal Event Listener to trigger map resize
        var mapModal = document.getElementById('mapModal');
        mapModal.addEventListener('shown.bs.modal', function () {
            initMap();
            setTimeout(function () {
                map.invalidateSize();
            }, 10);
        });
    });
</script>
{% endblock %}