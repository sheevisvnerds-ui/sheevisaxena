{% extends 'base.html' %}

{% block title %}Complete Job #{{ pickup.id }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex align-items-center mb-4">
        <a href="{% url 'agent_dashboard' %}"
            class="btn btn-outline-light text-dark btn-sm me-3 border-secondary rounded-circle"
            style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h4 class="fw-bold mb-0">Job #{{ pickup.id }}</h4>
            <span class="text-muted small">Assigned To You</span>
        </div>
    </div>

    <div class="row g-4">
        <!-- Customer Details Card -->
        <div class="col-12 col-md-4">
            <div class="card glass-card border-0 h-100">
                <div class="card-body">
                    <h5 class="fw-bold text-success mb-3"><i class="fas fa-user-circle me-2"></i>Customer</h5>

                    <div class="mb-4 text-center">
                        <div class="feature-icon mx-auto rounded-circle mb-3"
                            style="width: 60px; height: 60px; font-size: 1.5rem;">
                            <i class="fas fa-user"></i>
                        </div>
                        <h5 class="fw-bold">{{ pickup.customer.name|default:pickup.customer.username }}</h5>
                        <p class="text-muted mb-2">{{ pickup.customer.email }}</p>
                        <a href="tel:{{ pickup.customer.phone }}"
                            class="btn btn-outline-primary btn-sm rounded-pill px-4">
                            <i class="fas fa-phone me-1"></i> Call Now
                        </a>
                    </div>

                    <hr class="opacity-25 my-4">

                    <div class="d-flex align-items-start gap-3">
                        <i class="fas fa-map-marker-alt text-danger fs-5 mt-1"></i>
                        <div>
                            <small class="text-muted fw-bold text-uppercase">Pickup Address</small>
                            <p class="mb-0 fw-bold">{{ pickup.address }}</p>
                        </div>
                    </div>

                    <div class="d-flex align-items-start gap-3 mt-3">
                        <i class="fas fa-calendar-alt text-primary fs-5 mt-1"></i>
                        <div>
                            <small class="text-muted fw-bold text-uppercase">Scheduled Time</small>
                            <p class="mb-0 fw-bold">{{ pickup.scheduled_date|date:"l, d M Y" }}</p>
                            <small class="text-muted">{{ pickup.scheduled_date|date:"h:i A" }}</small>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Collection Form -->
        <div class="col-12 col-md-8">
            <div class="card glass-card border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold text-success m-0"><i class="fas fa-weight-hanging me-2"></i>Record Collection
                        </h5>
                        <span class="badge bg-secondary">Step 2/2</span>
                    </div>

                    <div class="bg-white bg-opacity-25 p-4 rounded-3 mb-4 border border-white">
                        <label class="form-label fw-bold text-uppercase small text-muted mb-3">Add Scrap Items</label>
                        <div class="row g-2">
                            <div class="col-12 col-sm-6">
                                <select id="categorySelect" class="form-select form-select-lg">
                                    <option value="" selected disabled>Select Category</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" data-rate="{{ cat.rate_per_kg }}">{{ cat.name }} (₹{{
                                        cat.rate_per_kg }}/kg)</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-8 col-sm-4">
                                <div class="input-group input-group-lg">
                                    <input type="number" id="weightInput" class="form-control" placeholder="0.0"
                                        step="0.1" min="0">
                                    <span class="input-group-text bg-transparent border-start-0">Kg</span>
                                </div>
                            </div>
                            <div class="col-4 col-sm-2">
                                <button type="button"
                                    class="btn btn-primary-custom w-100 h-100 d-flex align-items-center justify-content-center"
                                    onclick="addItem()">
                                    <i class="fas fa-plus fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <form method="post" id="collectionForm">
                        {% csrf_token %}

                        <div class="table-responsive mb-4 rounded-3 overflow-hidden border border-white">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Category</th>
                                        <th>Weight</th>
                                        <th>Rate</th>
                                        <th class="text-end pe-4">Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody" class="bg-white bg-opacity-50">
                                    <tr id="emptyRow">
                                        <td colspan="5" class="text-center py-4 text-muted fst-italic">
                                            No items added yet. Use the form above.
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="bg-success bg-opacity-10">
                                    <tr>
                                        <td colspan="3" class="text-end fw-bold py-3">Total Payable Amount:</td>
                                        <td class="text-end fw-bold text-success fs-5 py-3">₹<span
                                                id="totalAmountDisplay">0.00</span></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="alert alert-warning border-0 d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle fs-4 me-3"></i>
                            <div>
                                <strong>Collect Payment First!</strong>
                                <div class="small">Ensure you have paid <b>₹<span id="alertAmount">0.00</span></b> to
                                    the customer before finalizing.</div>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success btn-lg shadow-sm" id="submitBtn" disabled>
                                <span class="fw-bold">Finalize Collection & Close Job</span>
                                <i class="fas fa-check-circle ms-2"></i>
                            </button>
                        </div>
                    </form>

                    <script>
                        let totalAmount = 0;

                        function addItem() {
                            const categorySelect = document.getElementById('categorySelect');
                            const weightInput = document.getElementById('weightInput');
                            const tbody = document.getElementById('itemsTableBody');
                            const emptyRow = document.getElementById('emptyRow');
                            const totalDisplay = document.getElementById('totalAmountDisplay');
                            const alertAmount = document.getElementById('alertAmount');
                            const submitBtn = document.getElementById('submitBtn');

                            const catId = categorySelect.value;
                            const catName = categorySelect.options[categorySelect.selectedIndex].text.split('(')[0].trim();
                            // Safer parsing of rate from option text or data attribute if simpler
                            const rate = parseFloat(categorySelect.options[categorySelect.selectedIndex].getAttribute('data-rate'));
                            const weight = parseFloat(weightInput.value);

                            if (!catId || !weight || weight <= 0) {
                                alert("Please select a valid category and weight.");
                                return;
                            }

                            if (emptyRow) emptyRow.remove();

                            const lineTotal = weight * rate;
                            totalAmount += lineTotal;

                            const row = document.createElement('tr');
                            row.innerHTML = `
                        <td class="ps-4 fw-bold text-dark">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-success bg-opacity-10 p-2 me-2 d-flex align-items-center justify-content-center" style="width:32px;height:32px">
                                    <i class="fas fa-recycle text-success small"></i>
                                </div>
                                ${catName}
                            </div>
                            <input type="hidden" name="category[]" value="${catId}">
                        </td>
                        <td><span class="badge bg-light text-dark border">${weight} kg</span>
                            <input type="hidden" name="weight[]" value="${weight}">
                        </td>
                        <td class="text-muted small">₹${rate}/kg</td>
                        <td class="text-end fw-bold pe-4">₹${lineTotal.toFixed(2)}</td>
                        <td class="text-end pe-3">
                            <button type="button" class="btn btn-link text-danger p-0" onclick="removeItem(this, ${lineTotal})">
                                <i class="fas fa-times-circle fs-5"></i>
                            </button>
                        </td>
                    `;

                            // Animation
                            row.style.opacity = '0';
                            tbody.appendChild(row);
                            setTimeout(() => row.style.opacity = '1', 50);
                            row.style.transition = 'opacity 0.3s';

                            updateTotals(totalAmount);

                            // Reset inputs
                            categorySelect.value = "";
                            weightInput.value = "";
                            weightInput.focus();
                        }

                        function removeItem(btn, amount) {
                            const row = btn.closest('tr');
                            row.style.opacity = '0';
                            setTimeout(() => row.remove(), 300);

                            totalAmount -= amount;
                            updateTotals(totalAmount);

                            if (document.getElementById('itemsTableBody').children.length <= 1) { // 1 because we are removing one
                                // Logic to show empty row again if needed, or just keep it simple
                            }
                        }

                        function updateTotals(amount) {
                            const display = amount.toFixed(2);
                            document.getElementById('totalAmountDisplay').textContent = display;
                            document.getElementById('alertAmount').textContent = display;

                            const submitBtn = document.getElementById('submitBtn');
                            if (amount > 0) {
                                submitBtn.disabled = false;
                            } else {
                                submitBtn.disabled = true;
                            }
                        }
                    </script>

                </div>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const weightInput = document.querySelector('input[name="actual_weight"]');
        const totalDisplay = document.getElementById('live-total');
        const ratePerKg = {{ pickup.scrap_category.rate_per_kg|default: "0"
    }};

    weightInput.addEventListener('input', function () {
        const weight = parseFloat(this.value) || 0;
        const total = weight * ratePerKg;
        totalDisplay.textContent = '₹' + total.toFixed(2);
    });
    });
</script>
</div>
</div>
</div>
{% endblock %}